<ion-header *ngIf="showHeader">
  <lib-header></lib-header>
</ion-header>

<ion-content [fullscreen]="true">

  <div class="plan-container" *ngIf="!loading && !error && planData">
    <div class="user-info">
      <h2>Plano Integrativo</h2>
      <p class="user-subtitle">{{ planData.user_name }}</p>
    </div>

    <!-- Segment for Plan Sections -->
    <ion-segment 
      [(ngModel)]="selectedTab" 
      (ionChange)="onTabChange($event)"
      class="plan-tabs-segment"
      scrollable="true">
      <ion-segment-button 
        *ngFor="let planKey of getPlanKeys()" 
        [value]="planKey"
        class="plan-tab-button">
        <ion-icon [name]="getIconForPlanType(planKey)"></ion-icon>
        <ion-label>{{ formatPlanType(planKey) }}</ion-label>
      </ion-segment-button>
    </ion-segment>

    <!-- Content for Selected Plan Section -->
    <div class="tab-content-container" *ngIf="selectedTab">
      <ion-card class="plan-section-card">
        <ion-card-header>
          <ion-card-title>
            <ion-icon [name]="getIconForPlanType(selectedTab)"></ion-icon>
            {{ formatPlanType(selectedTab) }}
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <!-- Display plan data excluding metadata -->
          <div class="plan-details" *ngIf="getPlanItemSafe(selectedTab)?.plan_data">
            <div class="detail-item" *ngFor="let item of groupPlanItemsBySection(getPlanItemSafe(selectedTab)?.plan_data || {}); let i = index">
              <div *ngIf="item.items.length > 0">
                <!-- Section Header -->
                <h3 class="section-header">{{ item.sectionName }}</h3>
                <!-- Section Items -->
                <div class="section-items">
                  <div class="detail-subitem" *ngFor="let subItem of item.items">
                    <div *ngIf="shouldDisplayKey(subItem.key) && subItem.value !== null && subItem.value !== undefined && subItem.value !== ''">
                      <h4 class="detail-key">{{ formatKey(subItem.key) }}</h4>
                      <div class="detail-value">
                        <!-- Handle arrays -->
                        <div *ngIf="subItem.value && isArray(subItem.value); else singleValue">
                          <ul *ngIf="isStringArray(subItem.value); else objectArray">
                            <li *ngFor="let arrayItem of subItem.value">{{ arrayItem }}</li>
                          </ul>
                          <ng-template #objectArray>
                            <div class="object-item" *ngFor="let arrayItem of subItem.value; let j = index">
                              <strong>{{ j + 1 }}.</strong>
                              <div *ngFor="let objItem of flattenObject(arrayItem)">
                                <span *ngIf="objItem.value"><strong>{{ formatKey(objItem.key) }}:</strong> {{ objItem.value }}</span>
                              </div>
                            </div>
                          </ng-template>
                        </div>
                        <ng-template #singleValue>
                          <p>{{ subItem.value }}</p>
                        </ng-template>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Plan timestamps -->
          <div class="plan-timestamps">
            <p class="timestamp" *ngIf="getPlanItemSafe(selectedTab)?.created_at">
              <ion-icon name="calendar-outline"></ion-icon>
              Criado em: {{ getPlanItemSafe(selectedTab)?.created_at | date:'dd/MM/yyyy HH:mm' }}
            </p>
            <p class="timestamp" *ngIf="getPlanItemSafe(selectedTab)?.updated_at">
              <ion-icon name="time-outline"></ion-icon>
              Atualizado em: {{ getPlanItemSafe(selectedTab)?.updated_at | date:'dd/MM/yyyy HH:mm' }}
            </p>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Overall plan metadata -->
      <div class="plan-meta" *ngIf="planData.updated_at">
        <p class="updated-date">
          <ion-icon name="time-outline"></ion-icon>
          Plano atualizado em: {{ planData.updated_at | date:'dd/MM/yyyy HH:mm' }}
        </p>
      </div>
    </div>
  </div>

  <div class="loading-container" *ngIf="loading">
    <ion-spinner></ion-spinner>
    <p>Carregando plano completo...</p>
  </div>

  <!-- Plan Generation in Progress -->
  <div class="generating-container" *ngIf="generating">
    <ion-card class="status-card">
      <ion-card-content class="ion-text-center">
        <ion-icon name="construct-outline" color="primary" size="large"></ion-icon>
        <h3>Gerando Plano</h3>
        <p>{{ generatingMessage }}</p>
        <ion-spinner></ion-spinner>
        <p class="subtitle">Este processo pode levar alguns minutos...</p>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Profile Incomplete State -->
  <div class="profile-incomplete-container" *ngIf="showProfileIncomplete && !generating">
    <ion-card class="status-card">
      <ion-card-content class="ion-text-center">
        <ion-icon 
          [name]="profileStatus?.profile_status === 'empty' ? 'person-circle-outline' : 'warning-outline'" 
          [color]="profileStatus?.profile_status === 'empty' ? 'medium' : 'warning'" 
          size="large">
        </ion-icon>
        <h3 *ngIf="profileStatus?.profile_status === 'empty'">Complete Seu Perfil</h3>
        <h3 *ngIf="profileStatus?.profile_status === 'partial'">Perfil Incompleto</h3>
        <p>{{ profileMessage }}</p>
        
        <!-- Progress bar for partial profiles -->
        <div *ngIf="profileStatus?.profile_status === 'partial'" class="profile-progress">
          <ion-progress-bar [value]="(profileStatus?.completion_percentage || 0) / 100"></ion-progress-bar>
          <p class="progress-text">{{ profileStatus?.completion_percentage }}% completo</p>
        </div>
        
        <div class="button-group">
          <ion-button fill="solid" color="primary" (click)="goToProfileData()">
            <ion-icon name="person-outline" slot="start"></ion-icon>
            {{ profileStatus?.profile_status === 'empty' ? 'Completar Perfil' : 'Finalizar Perfil' }}
          </ion-button>
          
          <!-- Allow proceeding with partial profile -->
          <ion-button 
            *ngIf="profileStatus?.profile_status === 'partial'" 
            fill="outline" 
            color="secondary" 
            (click)="proceedWithPartialProfile()">
            <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
            Criar Plano Mesmo Assim
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- No Plan State (only shown when profile is complete) -->
  <div class="no-plan-container" *ngIf="noPlan && !generating && !showProfileIncomplete">
    <ion-card class="status-card">
      <ion-card-content class="ion-text-center">
        <ion-icon name="document-outline" color="medium" size="large"></ion-icon>
        <h3>Nenhum Plano Encontrado</h3>
        <p>Não há um plano integrativo criado para este usuário.</p>
        <ion-button fill="solid" color="primary" (click)="createPlan()">
          <ion-icon name="add-circle-outline" slot="start"></ion-icon>
          Criar Plano Integrativo
        </ion-button>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Error State -->
  <div class="error-container" *ngIf="error">
    <ion-card class="status-card">
      <ion-card-content class="ion-text-center">
        <ion-icon name="alert-circle-outline" color="danger" size="large"></ion-icon>
        <h3>Erro ao carregar plano</h3>
        <p>{{ error }}</p>
        <ion-button fill="outline" (click)="retry()">
          <ion-icon name="refresh-outline" slot="start"></ion-icon>
          Tentar Novamente
        </ion-button>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>

<ion-footer *ngIf="showFooter">
  <ng-content select="[slot=footer]"></ng-content>
</ion-footer>